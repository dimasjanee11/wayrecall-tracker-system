# üß† Block 2: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

> **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ GPS —Å–æ–±—ã—Ç–∏–π, –≥–µ–æ–∑–æ–Ω—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏  
> **–°–µ—Ä–≤–∏—Å—ã (6):** Geozones, Notifications, Analytics, Integration, Sensors, Maintenance

---

## üìã –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ Block 2

| # | –°–µ—Ä–≤–∏—Å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | MVP | –°—Ç–∞—Ç—É—Å |
|---|--------|------------|-----|--------|
| 1 | **Geozones Service** | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–∑–æ–Ω, enter/leave —Å–æ–±—ã—Ç–∏—è | ‚úÖ | üìã –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω |
| 2 | **Notifications Service** | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: email, sms, push, webhook | ‚úÖ | üìã –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω |
| 3 | **Analytics Service** | –û—Ç—á—ë—Ç—ã, –∞–≥—Ä–µ–≥–∞—Ü–∏—è, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ | ‚úÖ | üìã –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω |
| 4 | **Integration Service** | –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤ Wialon, webhooks, API | ‚úÖ | üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è |
| 5 | **Sensors Service** | –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—á–∏–∫–æ–≤, –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–æ–ø–ª–∏–≤–∞ | ‚úÖ | üìã –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω |
| 6 | **Maintenance Service** | –¢–û –ø–æ –ø—Ä–æ–±–µ–≥—É/–º–æ—Ç–æ—á–∞—Å–∞–º, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è | ‚è≥ | üìã PostMVP |

---

## üìã –û–±–∑–æ—Ä –±–ª–æ–∫–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         BLOCK 2: BUSINESS LOGIC                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ                        Kafka (gps-events)                                   ‚îÇ
‚îÇ                               ‚îÇ                                             ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ         ‚îÇ           ‚îÇ         ‚îÇ         ‚îÇ           ‚îÇ                      ‚îÇ
‚îÇ         ‚ñº           ‚ñº         ‚ñº         ‚ñº           ‚ñº                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ Geozones  ‚îÇ‚îÇ Sensors   ‚îÇ‚îÇ Analytics ‚îÇ‚îÇIntegration‚îÇ‚îÇMaintenance‚îÇ        ‚îÇ
‚îÇ  ‚îÇ Service   ‚îÇ‚îÇ Service   ‚îÇ‚îÇ Service   ‚îÇ‚îÇ Service   ‚îÇ‚îÇ Service   ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ        ‚îÇ            ‚îÇ            ‚îÇ            ‚îÇ            ‚îÇ               ‚îÇ
‚îÇ        ‚îÇ geozone-   ‚îÇ sensor-    ‚îÇ            ‚îÇ retrans-   ‚îÇ maint-       ‚îÇ
‚îÇ        ‚îÇ events     ‚îÇ events     ‚îÇ            ‚îÇ late       ‚îÇ events       ‚îÇ
‚îÇ        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                               ‚îÇ                                             ‚îÇ
‚îÇ                               ‚ñº                                             ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                  ‚îÇ
‚îÇ                    ‚îÇ   Notifications     ‚îÇ                                  ‚îÇ
‚îÇ                    ‚îÇ      Service        ‚îÇ                                  ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                  ‚îÇ
‚îÇ                               ‚îÇ                                             ‚îÇ
‚îÇ                               ‚ñº                                             ‚îÇ
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ              ‚îÇ        ‚îÇ       ‚îÇ       ‚îÇ        ‚îÇ                           ‚îÇ
‚îÇ              ‚ñº        ‚ñº       ‚ñº       ‚ñº        ‚ñº                           ‚îÇ
‚îÇ            Email    SMS    Push   Webhook  Telegram                        ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö Block 2

```mermaid
flowchart TB
    subgraph Input["–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"]
        GPS[Kafka: gps-events]
        CMD[Kafka: command-events]
    end

    subgraph Processing["–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π"]
        GS[Geozones Service]
        SS[Sensors Service]
        AS[Analytics Service]
        IS[Integration Service]
        MS[Maintenance Service]
    end

    subgraph Events["–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è"]
        GE[Kafka: geozone-events]
        SE[Kafka: sensor-events]
        AE[Kafka: analytics-events]
        ME[Kafka: maintenance-events]
    end

    subgraph Notifications["–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"]
        NS[Notifications Service]
    end

    subgraph Delivery["–ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏"]
        Email[üìß Email]
        SMS[üì± SMS]
        Push[üîî Push]
        WH[üåê Webhook]
        TG[üí¨ Telegram]
    end

    subgraph External["–í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"]
        Wialon[Wialon]
        GLONASS[–ì–õ–û–ù–ê–°–°-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥]
        Custom[Custom API]
    end

    GPS --> GS & SS & AS & MS
    GPS --> IS
    
    GS --> GE
    SS --> SE
    AS --> AE
    MS --> ME
    
    GE & SE & AE & ME --> NS
    NS --> Email & SMS & Push & WH & TG
    
    IS --> Wialon & GLONASS & Custom
```

---

## üó∫Ô∏è Geozones Service

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ GPS —Ç–æ—á–µ–∫ –Ω–∞ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –≥–µ–æ–∑–æ–Ω—ã, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è enter/leave —Å–æ–±—ã—Ç–∏–π

> **–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [GEOZONES_SERVICE_DESIGN.md](./GEOZONES_SERVICE_DESIGN.md)  
> **FAQ:** [GEOZONES_DETAILED_FAQ.md](./GEOZONES_DETAILED_FAQ.md)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Input["–í—Ö–æ–¥"]
        Kafka[Kafka: gps-events]
    end

    subgraph Optimizations["–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏"]
        RND["1Ô∏è‚É£ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã\nRounding 0.0003¬∞"]
        SG["2Ô∏è‚É£ Spatial Grid\nRedis Cache"]
        DDP["3Ô∏è‚É£ Device-Zone\nAssignment"]
        SL["4Ô∏è‚É£ Skip Logic\nWas inside?"]
    end

    subgraph Core["–Ø–¥—Ä–æ"]
        PostGIS["PostGIS\nST_Covers()"]
        State["State Manager\nRedis"]
    end

    subgraph Output["–í—ã—Ö–æ–¥"]
        Events[Kafka: geozone-events]
    end

    Kafka --> RND --> SG --> DDP --> SL --> PostGIS
    PostGIS --> State --> Events
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (8 —É—Ä–æ–≤–Ω–µ–π)

| # | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|------------|------------|----------|
| 1 | Coordinate Rounding | ~30% | 0.0003¬∞ = ~30–º —Ç–æ—á–Ω–æ—Å—Ç—å |
| 2 | Spatial Grid Index | 50-80% | Redis –∫–µ—à –∑–æ–Ω –ø–æ —è—á–µ–π–∫–∞–º |
| 3 | Device-Zone Assignment | 70-90% | –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ‚Üí –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã |
| 4 | "Was Inside" Skip | 40-60% | –ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ ‚Üí –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å |
| 5 | Batch Processing | Latency | Kafka micro-batches |
| 6 | PostGIS GIST Index | ~90% | –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å |
| 7 | Simplified Geometry | ~20% | ST_Simplify –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö |
| 8 | Inverted Grid | –ë—ã—Å—Ç—Ä–µ–µ | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ |

### –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

```
10,000 GPS —Ç–æ—á–µ–∫/—Å–µ–∫
    ‚Üì –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ 1-4
~100-200 PostGIS –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫
    ‚Üì PostGIS GIST + Batch
~10-20 –º—Å –Ω–∞ –±–∞—Ç—á
```

### Sequence Diagram

```mermaid
sequenceDiagram
    participant K as Kafka gps-events
    participant GS as Geozones Service
    participant RG as Redis Grid
    participant RS as Redis State
    participant PG as PostGIS
    participant KE as Kafka geozone-events

    K->>GS: Poll GPS points (batch)
    
    loop –î–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏
        GS->>GS: Round coordinates (0.0003)
        GS->>RG: GET grid:{hash}
        
        alt –ö–µ—à hit
            RG-->>GS: [zone_ids]
        else –ö–µ—à miss
            GS->>PG: SELECT zones WHERE grid_cell = ?
            PG-->>GS: [zone_ids]
            GS->>RG: SET grid:{hash} = [zone_ids]
        end
        
        GS->>RS: GET state:{device_id}
        RS-->>GS: {inside_zones: [1,2,3]}
        
        alt –ï—Å—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            GS->>PG: ST_Covers(zone.geom, point)
            PG-->>GS: true/false
        end
        
        GS->>GS: Detect enter/leave
        GS->>RS: SET state:{device_id} = {...}
    end
    
    GS->>KE: Publish geozone-events
```

### PostgreSQL —Å—Ö–µ–º–∞

```sql
-- –ì–µ–æ–∑–æ–Ω—ã —Å PostGIS
CREATE TABLE geozones (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    organization_id INTEGER REFERENCES organizations(id),
    zone_type VARCHAR(20) DEFAULT 'polygon',  -- polygon, circle
    geometry GEOMETRY(Geometry, 4326) NOT NULL,
    color VARCHAR(7) DEFAULT '#FF0000',
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- GIST –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_geozones_geom ON geozones USING GIST (geometry);
CREATE INDEX idx_geozones_org ON geozones (organization_id) WHERE is_active = true;

-- Spatial Grid –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
CREATE TABLE geozone_grid (
    grid_hash VARCHAR(20) PRIMARY KEY,  -- geohash –∏–ª–∏ custom
    zone_ids INTEGER[] NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –°–≤—è–∑—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –≥–µ–æ–∑–æ–Ω–∞–º–∏
CREATE TABLE device_geozone_assignments (
    device_id INTEGER REFERENCES devices(id),
    geozone_id INTEGER REFERENCES geozones(id),
    PRIMARY KEY (device_id, geozone_id)
);

-- –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π –≥–µ–æ–∑–æ–Ω
CREATE TABLE geozone_events (
    id BIGSERIAL PRIMARY KEY,
    device_id INTEGER NOT NULL,
    geozone_id INTEGER NOT NULL,
    event_type VARCHAR(10) NOT NULL,  -- 'enter' –∏–ª–∏ 'leave'
    timestamp TIMESTAMPTZ NOT NULL,
    lat DOUBLE PRECISION NOT NULL,
    lon DOUBLE PRECISION NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_geozone_events_device 
    ON geozone_events (device_id, timestamp DESC);
```

### Redis —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```
# Spatial Grid Cache (–∑–æ–Ω—ã –ø–æ —è—á–µ–π–∫–∞–º)
grid:{hash}
  value: [1, 5, 12, 45]  -- zone_ids
  TTL: 3600

# Device state (–≤ –∫–∞–∫–∏—Ö –∑–æ–Ω–∞—Ö —Å–µ–π—á–∞—Å)
geozone:state:{device_id}
  inside_zones: [1, 2, 3]
  last_check_ts: 1706270400
  last_position: {lat, lon}
  TTL: 86400

# Zone cache (–≥–µ–æ–º–µ—Ç—Ä–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–æ–Ω)
geozone:{id}
  name: "–û—Ñ–∏—Å"
  geometry: WKT –∏–ª–∏ GeoJSON
  bounds: {min_lat, min_lon, max_lat, max_lon}
  TTL: 3600
```

---

## üîî Notifications Service

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª, –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Sources["–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π"]
        GE[geozone-events]
        SE[sensor-events]
        AE[analytics-events]
        CE[command-events]
    end

    subgraph NS["Notifications Service"]
        Consumer[Event Consumer]
        Matcher[Rule Matcher]
        Templater[Template Engine]
        Dispatcher[Dispatcher]
    end

    subgraph Channels["–ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏"]
        Email[Email Service\nSMTP/SendGrid]
        SMS[SMS Gateway\nTwilio]
        Push[Push Service\nFCM/APNs]
        WH[Webhook\nHTTP POST]
        TG[Telegram Bot]
    end

    subgraph Storage["–•—Ä–∞–Ω–∏–ª–∏—â–µ"]
        PG[(PostgreSQL)]
        Redis[(Redis)]
    end

    GE & SE & AE & CE --> Consumer
    Consumer --> Matcher
    Matcher --> Templater --> Dispatcher
    Dispatcher --> Email & SMS & Push & WH & TG
    
    Matcher --> PG
    Dispatcher --> Redis
```

### Sequence Diagram: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è

```mermaid
sequenceDiagram
    participant K as Kafka
    participant NS as Notifications Service
    participant DB as PostgreSQL
    participant R as Redis
    participant Ch as Channels (Email/SMS/...)

    K->>NS: Event (geozone-enter)
    NS->>DB: Get rules for device/org
    DB-->>NS: [Rule1, Rule2, ...]
    
    loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
        NS->>NS: Check conditions
        
        alt –ü—Ä–∞–≤–∏–ª–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
            NS->>R: Check rate limit
            
            alt –ù–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
                NS->>NS: Apply template
                NS->>Ch: Send notification
                Ch-->>NS: Delivery status
                NS->>DB: Log notification
                NS->>R: Update rate limit counter
            else –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
                NS->>DB: Log skipped (rate limited)
            end
        end
    end
```

### PostgreSQL —Å—Ö–µ–º–∞

```sql
-- –ü—Ä–∞–≤–∏–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
CREATE TABLE notification_rules (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER REFERENCES organizations(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    
    -- –¢—Ä–∏–≥–≥–µ—Ä
    event_type VARCHAR(50) NOT NULL,      -- 'geozone_enter', 'geozone_leave', 'speed_exceed', etc
    
    -- –£—Å–ª–æ–≤–∏—è (JSON)
    conditions JSONB NOT NULL DEFAULT '{}',
    -- –ü—Ä–∏–º–µ—Ä: {"geozone_ids": [1,2,3], "device_ids": [100,101], "time_range": {"start": "08:00", "end": "18:00"}}
    
    -- –ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏
    channels JSONB NOT NULL DEFAULT '[]',
    -- –ü—Ä–∏–º–µ—Ä: [{"type": "email", "recipients": ["a@b.com"]}, {"type": "sms", "phones": ["+79001234567"]}]
    
    -- –®–∞–±–ª–æ–Ω—ã
    template_subject VARCHAR(200),
    template_body TEXT,
    
    -- Rate limiting
    cooldown_minutes INTEGER DEFAULT 5,   -- –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
    max_per_hour INTEGER DEFAULT 10,
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notification_rules_org ON notification_rules (organization_id) WHERE is_active = true;
CREATE INDEX idx_notification_rules_event ON notification_rules (event_type) WHERE is_active = true;

-- –ñ—É—Ä–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
CREATE TABLE notification_log (
    id BIGSERIAL PRIMARY KEY,
    rule_id INTEGER REFERENCES notification_rules(id),
    event_id BIGINT,                      -- ID –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
    event_type VARCHAR(50) NOT NULL,
    device_id INTEGER,
    
    channel VARCHAR(20) NOT NULL,         -- email, sms, push, webhook, telegram
    recipient VARCHAR(200) NOT NULL,      -- email address, phone, user_id, url
    
    subject VARCHAR(200),
    body TEXT,
    
    status VARCHAR(20) NOT NULL,          -- pending, sent, delivered, failed, rate_limited
    error_message TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    sent_at TIMESTAMPTZ,
    delivered_at TIMESTAMPTZ
);

CREATE INDEX idx_notification_log_device ON notification_log (device_id, created_at DESC);
CREATE INDEX idx_notification_log_status ON notification_log (status) WHERE status = 'pending';

-- –®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
CREATE TABLE notification_templates (
    id SERIAL PRIMARY KEY,
    event_type VARCHAR(50) NOT NULL,
    language VARCHAR(5) DEFAULT 'ru',
    channel VARCHAR(20) NOT NULL,
    subject VARCHAR(200),
    body TEXT NOT NULL,
    
    UNIQUE (event_type, language, channel)
);
```

### Redis —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```
# Rate limiting
rate_limit:{rule_id}:{device_id}:{hour}
  count: 5
  TTL: 3600

# Cooldown (–ø–æ—Å–ª–µ–¥–Ω–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
cooldown:{rule_id}:{device_id}
  sent_at: 1706270400
  TTL: cooldown_minutes * 60

# Pending notifications queue
pending_notifications
  ZSET –ø–æ timestamp
```

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

```
# –°–æ–±—ã—Ç–∏—è
notifications_events_received_total{event_type="geozone_enter"} 50000
notifications_events_processed_total{event_type="geozone_enter"} 50000

# –ü—Ä–∞–≤–∏–ª–∞
notifications_rules_matched_total{rule_id="1"} 1200
notifications_rules_skipped_total{reason="rate_limited"} 350

# –î–æ—Å—Ç–∞–≤–∫–∞
notifications_sent_total{channel="email", status="success"} 4500
notifications_sent_total{channel="sms", status="success"} 1200
notifications_sent_total{channel="email", status="failed"} 23

# Latency
notifications_delivery_duration_ms{channel="email", quantile="0.5"} 850
notifications_delivery_duration_ms{channel="sms", quantile="0.5"} 1200
```

---

## üìä Analytics Service

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Input["–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"]
        GPS[Kafka: gps-events]
        TSDB[(TimescaleDB)]
    end

    subgraph AS["Analytics Service"]
        Stream[Stream Processor]
        Aggregator[Time Aggregator]
        Reporter[Report Generator]
        Scheduler[Scheduled Jobs]
    end

    subgraph Output["–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"]
        Cache[(Redis Cache)]
        Reports[(Report Storage)]
        Kafka2[Kafka: analytics-events]
    end

    GPS --> Stream --> Aggregator
    TSDB --> Reporter
    Scheduler --> Reporter
    
    Aggregator --> Cache
    Aggregator --> Kafka2
    Reporter --> Reports
```

### –¢–∏–ø—ã –æ—Ç—á—ë—Ç–æ–≤

| –û—Ç—á—ë—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å |
|-------|----------|---------------|
| Daily Summary | –ü—Ä–æ–±–µ–≥, –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã, —Å—Ç–æ—è–Ω–∫–∏ | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ |
| Trip Report | –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ | –ü–æ –∑–∞–ø—Ä–æ—Å—É |
| Fuel Report | –†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞, –∑–∞–ø—Ä–∞–≤–∫–∏, —Å–ª–∏–≤—ã | –ü–æ –∑–∞–ø—Ä–æ—Å—É |
| Speed Violations | –ü—Ä–µ–≤—ã—à–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ | –ü–æ –∑–∞–ø—Ä–æ—Å—É |
| Geozone Visits | –ü–æ—Å–µ—â–µ–Ω–∏—è –≥–µ–æ–∑–æ–Ω | –ü–æ –∑–∞–ø—Ä–æ—Å—É |
| Driver Behavior | –û—Ü–µ–Ω–∫–∞ —Å—Ç–∏–ª—è –≤–æ–∂–¥–µ–Ω–∏—è | –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ |

### Sequence Diagram: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞

```mermaid
sequenceDiagram
    participant UI as Web UI
    participant API as API Gateway
    participant AS as Analytics Service
    participant R as Redis
    participant DB as TimescaleDB
    participant S3 as File Storage

    UI->>API: POST /reports {type: "trip", device_id: 123, period: "2026-01-01/2026-01-31"}
    API->>AS: Generate report request
    
    AS->>R: GET cached_report:{hash}
    
    alt –ö–µ—à hit
        R-->>AS: Report URL
        AS-->>API: {status: "ready", url: "..."}
    else –ö–µ—à miss
        AS->>AS: Queue report job
        AS-->>API: {status: "processing", job_id: 456}
        
        Note over AS,DB: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        AS->>DB: SELECT trips, stops, etc.
        DB-->>AS: Raw data
        AS->>AS: Calculate metrics
        AS->>AS: Generate Excel/PDF
        AS->>S3: Upload report file
        AS->>R: SET cached_report:{hash} = url
        AS->>R: PUBLISH report_ready:{job_id}
    end

    UI->>API: GET /reports/456
    API->>AS: Get report status
    AS-->>API: {status: "ready", url: "..."}
    API-->>UI: Report download link
```

### PostgreSQL —Å—Ö–µ–º–∞

```sql
-- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º
CREATE TABLE device_daily_stats (
    device_id INTEGER NOT NULL,
    date DATE NOT NULL,
    
    -- –ü—Ä–æ–±–µ–≥
    total_distance_km DECIMAL(10,2),
    
    -- –í—Ä–µ–º—è
    engine_hours INTEGER,          -- –º–∏–Ω—É—Ç—ã
    moving_time INTEGER,           -- –º–∏–Ω—É—Ç—ã
    idle_time INTEGER,             -- –º–∏–Ω—É—Ç—ã
    stopped_time INTEGER,          -- –º–∏–Ω—É—Ç—ã
    
    -- –°–∫–æ—Ä–æ—Å—Ç—å
    max_speed INTEGER,
    avg_speed DECIMAL(5,1),
    
    -- –¢–æ–ø–ª–∏–≤–æ
    fuel_consumed DECIMAL(8,2),
    fuel_refilled DECIMAL(8,2),
    
    -- –°—á—ë—Ç—á–∏–∫–∏
    trips_count INTEGER,
    stops_count INTEGER,
    speed_violations INTEGER,
    geozone_visits INTEGER,
    
    calculated_at TIMESTAMPTZ DEFAULT NOW(),
    
    PRIMARY KEY (device_id, date)
);

-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏
CREATE TABLE trips (
    id BIGSERIAL PRIMARY KEY,
    device_id INTEGER NOT NULL,
    
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    start_lat DOUBLE PRECISION,
    start_lon DOUBLE PRECISION,
    end_lat DOUBLE PRECISION,
    end_lon DOUBLE PRECISION,
    
    distance_km DECIMAL(10,2),
    max_speed INTEGER,
    avg_speed DECIMAL(5,1),
    duration_minutes INTEGER,
    
    start_address TEXT,
    end_address TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_trips_device ON trips (device_id, start_time DESC);

-- –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã
CREATE TABLE reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id INTEGER REFERENCES organizations(id),
    created_by INTEGER REFERENCES users(id),
    
    report_type VARCHAR(50) NOT NULL,
    parameters JSONB NOT NULL,       -- {device_ids, period, etc}
    
    status VARCHAR(20) NOT NULL,     -- pending, processing, ready, failed
    file_url TEXT,
    file_size INTEGER,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ           -- –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ N –¥–Ω–µ–π
);

CREATE INDEX idx_reports_org ON reports (organization_id, created_at DESC);
```

---

## üå°Ô∏è Sensors Service

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤ (—Ç–æ–ø–ª–∏–≤–æ, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –∏ —Ç.–¥.)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Input["–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"]
        GPS[Kafka: gps-events\nio_data field]
    end

    subgraph SS["Sensors Service"]
        Parser[IO Data Parser]
        Calibrator[Sensor Calibrator]
        Analyzer[Event Analyzer]
    end

    subgraph Detectors["–î–µ—Ç–µ–∫—Ç–æ—Ä—ã"]
        FD[Fuel Detector\n–ó–∞–ø—Ä–∞–≤–∫–∏/–°–ª–∏–≤—ã]
        TD[Temperature Detector\n–ü—Ä–µ–≤—ã—à–µ–Ω–∏—è]
        DD[Door Detector\n–û—Ç–∫—Ä—ã—Ç–∏—è]
    end

    subgraph Output["–í—ã—Ö–æ–¥"]
        Events[Kafka: sensor-events]
        DB[(TimescaleDB)]
    end

    GPS --> Parser --> Calibrator --> Analyzer
    Analyzer --> FD & TD & DD
    FD & TD & DD --> Events
    Calibrator --> DB
```

### –¢–∏–ø—ã –¥–∞—Ç—á–∏–∫–æ–≤

| –¢–∏–ø | IO Element | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|------------|----------|
| fuel_level | 65-67 | –£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞ (–ª–∏—Ç—Ä—ã) |
| temperature | 72-75 | –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C) |
| door_sensor | 175-178 | –î–∞—Ç—á–∏–∫ –¥–≤–µ—Ä–∏ (0/1) |
| ignition | 239 | –ó–∞–∂–∏–≥–∞–Ω–∏–µ (0/1) |
| battery | 67 | –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë |
| can_fuel | 83 | –¢–æ–ø–ª–∏–≤–æ –ø–æ CAN |
| can_rpm | 85 | –û–±–æ—Ä–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è |

### –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–æ–ø–ª–∏–≤–∞

```mermaid
flowchart LR
    subgraph Raw["–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ"]
        ADC[ADC –∑–Ω–∞—á–µ–Ω–∏–µ\n0-4095]
    end

    subgraph Calibration["–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞"]
        Table[–ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω–∞—è\n—Ç–∞–±–ª–∏—Ü–∞]
        Interp[–õ–∏–Ω–µ–π–Ω–∞—è\n–∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è]
    end

    subgraph Result["–†–µ–∑—É–ª—å—Ç–∞—Ç"]
        Liters[–õ–∏—Ç—Ä—ã\n0-500]
    end

    ADC --> Table --> Interp --> Liters
```

### PostgreSQL —Å—Ö–µ–º–∞

```sql
-- –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–∞—Ç—á–∏–∫–æ–≤
CREATE TABLE sensor_calibrations (
    id SERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(id),
    sensor_type VARCHAR(20) NOT NULL,     -- fuel_level, temperature, etc
    io_element INTEGER NOT NULL,          -- –Ω–æ–º–µ—Ä IO —ç–ª–µ–º–µ–Ω—Ç–∞
    
    -- –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (–º–∞—Å—Å–∏–≤)
    calibration_points JSONB NOT NULL,
    -- –ü—Ä–∏–º–µ—Ä: [[0, 0], [1000, 50], [2000, 100], [3000, 150], [4096, 200]]
    -- [ADC value, liters/celsius/etc]
    
    unit VARCHAR(10),                     -- L, ¬∞C, V, etc
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE (device_id, sensor_type)
);

-- –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤ (hypertable)
CREATE TABLE sensor_data (
    device_id INTEGER NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    sensor_type VARCHAR(20) NOT NULL,
    raw_value INTEGER,
    calibrated_value DECIMAL(10,2),
    
    PRIMARY KEY (timestamp, device_id, sensor_type)
);

SELECT create_hypertable('sensor_data', 'timestamp',
    chunk_time_interval => INTERVAL '1 day'
);

-- –°–æ–±—ã—Ç–∏—è –¥–∞—Ç—á–∏–∫–æ–≤ (–∑–∞–ø—Ä–∞–≤–∫–∏, —Å–ª–∏–≤—ã, etc)
CREATE TABLE sensor_events (
    id BIGSERIAL PRIMARY KEY,
    device_id INTEGER NOT NULL,
    event_type VARCHAR(30) NOT NULL,      -- fuel_refill, fuel_drain, temp_exceed, door_open
    timestamp TIMESTAMPTZ NOT NULL,
    
    lat DOUBLE PRECISION,
    lon DOUBLE PRECISION,
    
    value_before DECIMAL(10,2),
    value_after DECIMAL(10,2),
    value_change DECIMAL(10,2),
    
    metadata JSONB,                       -- –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_sensor_events_device ON sensor_events (device_id, timestamp DESC);
```

---

## ÔøΩ Integration Service

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (Wialon, –ì–õ–û–ù–ê–°–°-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, webhooks)

**–§—É–Ω–∫—Ü–∏–∏:**
- –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è GPS –≤ Wialon IPS/Retranslator
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥–æ—Å—Å–∏—Å—Ç–µ–º—ã (–ì–õ–û–ù–ê–°–°-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –ü–ª–∞—Ç–æ–Ω)
- Webhooks –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–æ—Ä–º–∞—Ç—ã EGTS, NDTP

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Input["–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"]
        GPS[Kafka: gps-events]
    end

    subgraph IS["Integration Service"]
        Consumer[Event Consumer]
        Router[Protocol Router]
        Transformer[Data Transformer]
        Sender[Async Sender]
        RetryQueue[Retry Queue]
    end

    subgraph Protocols["–ü—Ä–æ—Ç–æ–∫–æ–ª—ã"]
        WIP[Wialon IPS]
        WRT[Wialon Retranslator]
        EGTS[EGTS/ERA-GLONASS]
        NDTP[NDTP]
        HTTP[HTTP/Webhook]
    end

    subgraph External["–í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"]
        Wialon[(Wialon)]
        Glonass[(–ì–õ–û–ù–ê–°–°-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)]
        Custom[(Custom Systems)]
    end

    subgraph Storage["–•—Ä–∞–Ω–∏–ª–∏—â–µ"]
        PG[(PostgreSQL\nintegration_log)]
        Redis[(Redis\nretry queue)]
    end

    GPS --> Consumer --> Router
    Router --> Transformer
    Transformer --> WIP & WRT & EGTS & NDTP & HTTP
    WIP & WRT --> Wialon
    EGTS --> Glonass
    HTTP --> Custom
    
    Sender --> RetryQueue --> Redis
    Sender --> PG
```

### Sequence Diagram: –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤ Wialon

```mermaid
sequenceDiagram
    participant K as Kafka gps-events
    participant IS as Integration Service
    participant DB as PostgreSQL
    participant R as Redis
    participant W as Wialon Server

    K->>IS: GPS point
    IS->>DB: Get integration config for device
    DB-->>IS: {protocol: "wialon_ips", host: "...", credentials: "..."}
    
    IS->>IS: Transform to Wialon IPS format
    IS->>W: Send packet
    
    alt –£—Å–ø–µ—à–Ω–æ
        W-->>IS: ACK
        IS->>DB: Log success
    else –û—à–∏–±–∫–∞
        W-->>IS: Error / Timeout
        IS->>R: ZADD retry_queue
        IS->>DB: Log failure
    end
    
    Note over IS,R: Retry worker (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)
    IS->>R: ZRANGEBYSCORE retry_queue
    R-->>IS: [failed_packets]
    IS->>W: Retry send
```

### PostgreSQL —Å—Ö–µ–º–∞

```sql
-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
CREATE TABLE integrations (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER REFERENCES organizations(id),
    name VARCHAR(100) NOT NULL,
    
    -- –¢–∏–ø –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    integration_type VARCHAR(30) NOT NULL,   -- wialon_ips, wialon_retranslator, egts, webhook
    
    -- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    host VARCHAR(255) NOT NULL,
    port INTEGER,
    protocol VARCHAR(10) DEFAULT 'tcp',      -- tcp, udp, http, https
    
    -- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    credentials JSONB,                        -- {login, password, api_key, etc}
    
    -- –§–∏–ª—å—Ç—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    device_ids INTEGER[],                     -- NULL = –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    
    -- –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    settings JSONB DEFAULT '{}',
    -- {
    --   "batch_size": 100,
    --   "send_interval_ms": 1000,
    --   "retry_attempts": 3,
    --   "timeout_ms": 5000
    -- }
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_integrations_org ON integrations (organization_id) WHERE is_active = true;

-- –ú–∞–ø–ø–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–ª—è Wialon (IMEI ‚Üí Unit ID)
CREATE TABLE integration_device_mapping (
    integration_id INTEGER REFERENCES integrations(id),
    device_id INTEGER REFERENCES devices(id),
    external_id VARCHAR(50) NOT NULL,         -- Unit ID –≤ Wialon
    external_name VARCHAR(100),
    
    PRIMARY KEY (integration_id, device_id)
);

-- –õ–æ–≥ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
CREATE TABLE integration_log (
    id BIGSERIAL PRIMARY KEY,
    integration_id INTEGER REFERENCES integrations(id),
    device_id INTEGER,
    
    points_count INTEGER,
    bytes_sent INTEGER,
    
    status VARCHAR(20) NOT NULL,              -- success, failed, timeout, partial
    error_message TEXT,
    
    sent_at TIMESTAMPTZ DEFAULT NOW(),
    response_time_ms INTEGER
);

CREATE INDEX idx_integration_log_integration 
    ON integration_log (integration_id, sent_at DESC);
```

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã

| –ü—Ä–æ—Ç–æ–∫–æ–ª | –§–æ—Ä–º–∞—Ç | –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|-------------|----------|
| Wialon IPS | Binary | ‚Üí Wialon | –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª Wialon |
| Wialon Retranslator | Binary | ‚Üí Wialon | –î–ª—è —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ |
| EGTS | Binary | ‚Üí –ì–õ–û–ù–ê–°–° | –ì–æ—Å. —Å—Ç–∞–Ω–¥–∞—Ä—Ç –†–§ |
| NDTP | Binary | ‚Üí –ù–∞–≤—Ç–µ–ª–µ–∫–æ–º | –ü—Ä–æ—Ç–æ–∫–æ–ª –ù–∞–≤—Ç–µ–ª–µ–∫–æ–º |
| Webhook | JSON/HTTP | ‚Üí Any | Universal HTTP POST |

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

```
# –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è
integration_packets_sent_total{integration_id="1", status="success"} 500000
integration_packets_sent_total{integration_id="1", status="failed"} 150

# Latency
integration_send_duration_ms{integration_id="1", quantile="0.5"} 45
integration_send_duration_ms{integration_id="1", quantile="0.99"} 200

# Retry queue
integration_retry_queue_size{integration_id="1"} 25

# Bytes
integration_bytes_sent_total{integration_id="1"} 125000000
```

---

## üîß Maintenance Service

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ö–æ–Ω—Ç—Ä–æ–ª—å –¢–û —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –ø–æ –ø—Ä–æ–±–µ–≥—É/–º–æ—Ç–æ—á–∞—Å–∞–º, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ

**–°—Ç–∞—Ç—É—Å:** PostMVP (–æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Input["–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"]
        GPS[Kafka: gps-events]
        Stats[device_daily_stats]
    end

    subgraph MS["Maintenance Service"]
        Calculator[Odometer Calculator]
        Checker[Maintenance Checker]
        Scheduler[Scheduled Jobs]
    end

    subgraph Rules["–ü—Ä–∞–≤–∏–ª–∞ –¢–û"]
        Mileage[–ü–æ –ø—Ä–æ–±–µ–≥—É\n10,000 –∫–º]
        Hours[–ü–æ –º–æ—Ç–æ—á–∞—Å–∞–º\n500 —á]
        Time[–ü–æ –≤—Ä–µ–º–µ–Ω–∏\n6 –º–µ—Å—è—Ü–µ–≤]
    end

    subgraph Output["–í—ã—Ö–æ–¥"]
        Events[Kafka: maintenance-events]
        DB[(PostgreSQL)]
    end

    GPS --> Calculator --> DB
    Stats --> Checker
    Scheduler --> Checker
    Checker --> Mileage & Hours & Time
    Mileage & Hours & Time --> Events
```

### Sequence Diagram: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–û

```mermaid
sequenceDiagram
    participant S as Scheduler (daily)
    participant MS as Maintenance Service
    participant DB as PostgreSQL
    participant K as Kafka maintenance-events

    S->>MS: Trigger daily check
    MS->>DB: Get vehicles with maintenance rules
    DB-->>MS: [vehicles with rules]
    
    loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ vehicle
        MS->>DB: Get current odometer / engine_hours
        DB-->>MS: {odometer: 45000, hours: 480}
        
        MS->>MS: Check rules
        
        alt –¢–û —Å–∫–æ—Ä–æ (–∑–∞ 500 –∫–º)
            MS->>K: maintenance_upcoming event
        else –¢–û –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
            MS->>K: maintenance_overdue event
        end
        
        MS->>DB: Update last_check
    end
```

### PostgreSQL —Å—Ö–µ–º–∞

```sql
-- –ü—Ä–∞–≤–∏–ª–∞ –¢–û
CREATE TABLE maintenance_rules (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER REFERENCES organizations(id),
    name VARCHAR(100) NOT NULL,               -- "–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞", "–¢–û-1"
    description TEXT,
    
    -- –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã (–ª—é–±–æ–π –∏–ª–∏ –≤—Å–µ)
    interval_km INTEGER,                      -- –∫–∞–∂–¥—ã–µ N –∫–º
    interval_hours INTEGER,                   -- –∫–∞–∂–¥—ã–µ N –º–æ—Ç–æ—á–∞—Å–æ–≤
    interval_days INTEGER,                    -- –∫–∞–∂–¥—ã–µ N –¥–Ω–µ–π
    
    -- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    warning_km INTEGER DEFAULT 500,           -- –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –∑–∞ N –∫–º
    warning_hours INTEGER DEFAULT 50,         -- –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –∑–∞ N —á–∞—Å–æ–≤
    warning_days INTEGER DEFAULT 14,          -- –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –∑–∞ N –¥–Ω–µ–π
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ü—Ä–∏–≤—è–∑–∫–∞ –ø—Ä–∞–≤–∏–ª –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
CREATE TABLE device_maintenance (
    device_id INTEGER REFERENCES devices(id),
    rule_id INTEGER REFERENCES maintenance_rules(id),
    
    -- –ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û
    last_maintenance_at TIMESTAMPTZ,
    last_maintenance_km INTEGER,
    last_maintenance_hours INTEGER,
    
    -- –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    current_odometer_km INTEGER DEFAULT 0,
    current_engine_hours INTEGER DEFAULT 0,
    
    -- –°—Ç–∞—Ç—É—Å
    status VARCHAR(20) DEFAULT 'ok',          -- ok, upcoming, overdue
    next_maintenance_km INTEGER,
    next_maintenance_at TIMESTAMPTZ,
    
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    PRIMARY KEY (device_id, rule_id)
);

-- –ñ—É—Ä–Ω–∞–ª –¢–û
CREATE TABLE maintenance_log (
    id BIGSERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(id),
    rule_id INTEGER REFERENCES maintenance_rules(id),
    
    performed_at TIMESTAMPTZ NOT NULL,
    odometer_km INTEGER,
    engine_hours INTEGER,
    
    notes TEXT,
    cost DECIMAL(10,2),
    
    performed_by VARCHAR(100),                -- –º–µ—Ö–∞–Ω–∏–∫
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INTEGER REFERENCES users(id)
);

CREATE INDEX idx_maintenance_log_device 
    ON maintenance_log (device_id, performed_at DESC);

### –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π

| –°–æ–±—ã—Ç–∏–µ | –£—Å–ª–æ–≤–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------|---------|----------|
| `maintenance_upcoming` | –î–æ –¢–û < warning | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "—Å–∫–æ—Ä–æ –¢–û" |
| `maintenance_overdue` | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ |
| `maintenance_performed` | –¢–û –≤—ã–ø–æ–ª–Ω–µ–Ω–æ | –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–æ–≤ |

---

## üîó –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ Block 2

```mermaid
sequenceDiagram
    participant K1 as Kafka gps-events
    participant GS as Geozones Service
    participant SS as Sensors Service
    participant IS as Integration Service
    participant K2 as Kafka geozone-events
    participant K3 as Kafka sensor-events
    participant NS as Notifications Service
    participant W as Wialon
    participant Ch as Channels

    Note over K1,Ch: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ GPS —Å–æ–±—ã—Ç–∏–π

    par Geozones
        K1->>GS: GPS point
        GS->>GS: Check geozones
        GS->>K2: Enter/Leave event
    and Sensors
        K1->>SS: GPS point (io_data)
        SS->>SS: Process sensors
        SS->>K3: Fuel drain event
    and Integration
        K1->>IS: GPS point
        IS->>W: Retranslate to Wialon
    end

    K2->>NS: Geozone enter
    K3->>NS: Fuel drain alert
    
    NS->>NS: Match rules
    NS->>Ch: Send notifications
```

---

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ Block 2 (–≤—Å–µ 6 —Å–µ—Ä–≤–∏—Å–æ–≤)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Geozones | Notifications | Analytics | Integration | Sensors | Maintenance |
|----------|----------|---------------|-----------|-------------|---------|-------------|
| **–í—Ö–æ–¥** | gps-events | –≤—Å–µ —Å–æ–±—ã—Ç–∏—è | gps-events, DB | gps-events | gps-events | daily_stats |
| **–í—ã—Ö–æ–¥** | geozone-events | –∫–∞–Ω–∞–ª—ã | reports | Wialon, etc | sensor-events | maint-events |
| **State** | Redis | PostgreSQL | Redis cache | PostgreSQL | PostgreSQL | PostgreSQL |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–∞—è |
| **MVP** | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚è≥ –ß–∞—Å—Ç–∏—á–Ω–æ | ‚úÖ –î–∞ | ‚è≥ –ß–∞—Å—Ç–∏—á–Ω–æ | ‚è≥ PostMVP |

---

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Docker Compose (dev)

```yaml
services:
  geozones-service:
    build: ./services/geozones-service
    environment:
      - KAFKA_BROKERS=kafka:9092
      - DATABASE_URL=postgresql://postgres:5432/tracker
      - REDIS_URL=redis://redis:6379
    depends_on:
      - kafka
      - timescaledb
      - redis

  notifications-service:
    build: ./services/notifications-service
    environment:
      - KAFKA_BROKERS=kafka:9092
      - DATABASE_URL=postgresql://postgres:5432/tracker
      - REDIS_URL=redis://redis:6379
      - SMTP_HOST=smtp.gmail.com
      - SMS_API_KEY=${SMS_API_KEY}
    depends_on:
      - kafka
      - postgres
      - redis

  analytics-service:
    build: ./services/analytics-service
    environment:
      - KAFKA_BROKERS=kafka:9092
      - DATABASE_URL=postgresql://postgres:5432/tracker
      - REDIS_URL=redis://redis:6379
      - S3_BUCKET=reports
    depends_on:
      - kafka
      - timescaledb
      - redis

  sensors-service:
    build: ./services/sensors-service
    environment:
      - KAFKA_BROKERS=kafka:9092
      - DATABASE_URL=postgresql://postgres:5432/tracker
    depends_on:
      - kafka
      - timescaledb

  integration-service:
    build: ./services/integration-service
    environment:
      - KAFKA_BROKERS=kafka:9092
      - DATABASE_URL=postgresql://postgres:5432/tracker
      - REDIS_URL=redis://redis:6379
    depends_on:
      - kafka
      - postgres
      - redis

  # maintenance-service: (PostMVP)
  #   build: ./services/maintenance-service
  #   ...
```

---

**–î–∞—Ç–∞:** 26 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** Block 2 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ ‚úÖ (6 —Å–µ—Ä–≤–∏—Å–æ–≤)

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** [ARCHITECTURE_BLOCK3.md](./ARCHITECTURE_BLOCK3.md) ‚Äî –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
