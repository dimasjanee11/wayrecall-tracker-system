# üîå Block 1: –°–±–æ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

> **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ü—Ä–∏—ë–º GPS –¥–∞–Ω–Ω—ã—Ö, –ø–∞—Ä—Å–∏–Ω–≥, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –∑–∞–ø–∏—Å—å –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ  
> **–°–µ—Ä–≤–∏—Å—ã:** Connection Manager, History Writer, Device Manager

---

## üìã –û–±–∑–æ—Ä –±–ª–æ–∫–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         BLOCK 1: DATA COLLECTION                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ     GPS       ‚îÇ  TCP   ‚îÇ  Connection   ‚îÇ Kafka  ‚îÇ   History     ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ   –¢—Ä–µ–∫–µ—Ä—ã     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Manager     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Writer      ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ               ‚îÇ        ‚îÇ               ‚îÇ        ‚îÇ               ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                   ‚îÇ                        ‚îÇ               ‚îÇ
‚îÇ                                   ‚îÇ Redis                  ‚îÇ Batch         ‚îÇ
‚îÇ                                   ‚ñº                        ‚ñº               ‚îÇ
‚îÇ                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ                           ‚îÇ     Redis     ‚îÇ        ‚îÇ  TimescaleDB  ‚îÇ       ‚îÇ
‚îÇ                           ‚îÇ  ‚Ä¢ positions  ‚îÇ        ‚îÇ  ‚Ä¢ gps_points ‚îÇ       ‚îÇ
‚îÇ                           ‚îÇ  ‚Ä¢ connections‚îÇ        ‚îÇ               ‚îÇ       ‚îÇ
‚îÇ                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                   ‚ñ≤                                        ‚îÇ
‚îÇ                                   ‚îÇ CRUD, Commands                         ‚îÇ
‚îÇ                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ                           ‚îÇ    Device     ‚îÇ                                ‚îÇ
‚îÇ                           ‚îÇ   Manager     ‚îÇ                                ‚îÇ
‚îÇ                           ‚îÇ               ‚îÇ                                ‚îÇ
‚îÇ                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö Block 1

```mermaid
flowchart LR
    subgraph Devices["üöó GPS –¢—Ä–µ–∫–µ—Ä—ã"]
        T1[Teltonika]
        T2[Wialon]
        T3[Ruptela]
        T4[NavTelecom]
    end

    subgraph CM["Connection Manager"]
        TCP[TCP Server]
        Parser[Protocol Parser]
        Filter[Filter & Validate]
        Publisher[Kafka Publisher]
    end

    subgraph Stores["–•—Ä–∞–Ω–∏–ª–∏—â–∞"]
        Kafka[(Kafka gps-events)]
        Redis[(Redis)]
        TSDB[(TimescaleDB)]
    end

    subgraph HW["History Writer"]
        Consumer[Kafka Consumer]
        Batcher[Batch Aggregator]
        Writer[DB Writer]
    end

    subgraph DM["Device Manager"]
        API[REST API]
        CmdQueue[Command Queue]
    end

    T1 & T2 & T3 & T4 --> TCP
    TCP --> Parser --> Filter --> Publisher
    Publisher --> Kafka
    Filter -.-> |last position| Redis
    
    Kafka --> Consumer --> Batcher --> Writer --> TSDB
    
    API --> Redis
    CmdQueue -.-> |Pub/Sub| TCP
```

---

## üñ•Ô∏è Connection Manager

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ü—Ä–∏—ë–º TCP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π, –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Kafka

**–ü–æ—Ä—Ç—ã:**
| –ü–æ—Ä—Ç | –ü—Ä–æ—Ç–æ–∫–æ–ª |
|------|----------|
| 5001 | Teltonika FM |
| 5002 | Wialon IPS/NIS |
| 5003 | Ruptela |
| 5004 | NavTelecom |

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Incoming["–í—Ö–æ–¥—è—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"]
        P5001[":5001 Teltonika"]
        P5002[":5002 Wialon"]
        P5003[":5003 Ruptela"]
        P5004[":5004 NavTelecom"]
    end

    subgraph TCPLayer["TCP Layer (ZIO)"]
        Acceptor[Connection Acceptor]
        ChannelPool[Channel Pool]
        Handler[Message Handler]
    end

    subgraph Parsers["Protocol Parsers"]
        TP[TeltonikaParser]
        WP[WialonParser]
        RP[RuptelaParser]
        NP[NavTelecomParser]
    end

    subgraph Pipeline["Processing Pipeline"]
        Validate[Validator]
        Filter[Distance/Time Filter]
        Transform[Transform to GpsPoint]
    end

    subgraph Output["Output"]
        KafkaPub[Kafka Publisher]
        RedisCache[Redis Position Cache]
    end

    P5001 & P5002 & P5003 & P5004 --> Acceptor
    Acceptor --> ChannelPool --> Handler
    Handler --> TP & WP & RP & NP
    TP & WP & RP & NP --> Validate --> Filter --> Transform
    Transform --> KafkaPub
    Transform --> RedisCache
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. TCP Server (ZIO)

```scala
// –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
trait ConnectionManager:
  def start: Task[Unit]
  def shutdown: Task[Unit]
  def metrics: Task[ConnectionMetrics]

case class ConnectionMetrics(
  activeConnections: Map[Protocol, Int],
  totalReceived: Long,
  totalErrors: Long
)
```

#### 2. Protocol Parser (Trait)

```scala
trait ProtocolParser[F[_]]:
  def parse(bytes: Chunk[Byte]): F[ParseResult]
  def buildAck(result: ParseResult): Chunk[Byte]
  def protocolName: String

sealed trait ParseResult
case class GpsPacket(
  imei: String,
  points: List[RawGpsPoint],
  ioData: Map[Int, Long]
) extends ParseResult
case class LoginRequest(imei: String) extends ParseResult
case class ParseError(reason: String) extends ParseResult
```

#### 3. Filter (–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫)

```scala
// –ü—Ä–∞–≤–∏–ª–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
case class FilterConfig(
  minDistanceMeters: Double = 5.0,    // –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ < 5–º
  minTimeSecs: Int = 5,               // –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ < 5 —Å–µ–∫
  maxSpeed: Double = 300.0,           // –æ—Ç–±—Ä–æ—Å–∏—Ç—å –µ—Å–ª–∏ > 300 –∫–º/—á (GPS –≥–ª—é–∫)
  invalidCoords: Boolean = true       // –æ—Ç–±—Ä–æ—Å–∏—Ç—å 0,0 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
)
```

### Sequence Diagram: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–µ–∫–µ—Ä–∞

```mermaid
sequenceDiagram
    participant T as –¢—Ä–µ–∫–µ—Ä
    participant CM as Connection Manager
    participant R as Redis
    participant K as Kafka

    T->>CM: TCP Connect :5001
    CM->>CM: Accept connection
    
    T->>CM: Login packet (IMEI)
    CM->>R: GET device:{imei}
    R-->>CM: Device config
    
    alt IMEI –Ω–∞–π–¥–µ–Ω
        CM->>CM: Store connection in memory
        CM->>R: SET conn:{imei} = {nodeId, timestamp}
        CM-->>T: ACK (login success)
    else IMEI –Ω–µ –Ω–∞–π–¥–µ–Ω
        CM-->>T: NACK (reject)
        CM->>CM: Close connection
    end

    loop GPS –ø–∞–∫–µ—Ç—ã
        T->>CM: GPS packet (N points)
        CM->>CM: Parse protocol
        CM->>CM: Validate & Filter
        CM->>K: Publish to gps-events
        CM->>R: SET pos:{imei} = {lat, lon, speed, ts}
        CM-->>T: ACK
    end

    T->>CM: Disconnect / Timeout
    CM->>R: DEL conn:{imei}
    CM->>CM: Cleanup connection
```

### Redis —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```
# –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–∑–∏—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ API)
pos:{imei}
  lat: 55.7558
  lon: 37.6173
  speed: 45.5
  course: 180
  timestamp: 1706270400
  TTL: 86400 (1 –¥–µ–Ω—å)

# –ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
conn:{imei}
  nodeId: "cm-node-1"
  connectedAt: 1706270000
  protocol: "teltonika"
  TTL: 300 (5 –º–∏–Ω—É—Ç, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)

# IMEI whitelist (–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
imei:valid:{imei}
  deviceId: 123
  orgId: 456
  TTL: 3600 (1 —á–∞—Å, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è Device Manager)
```

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

```
# –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º
gps_connections_active{protocol="teltonika"} 3500
gps_connections_active{protocol="wialon"} 2100

# –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
gps_packets_received_total{protocol="teltonika", status="success"} 1000000
gps_packets_received_total{protocol="teltonika", status="parse_error"} 150
gps_packets_received_total{protocol="teltonika", status="filtered"} 25000

# Latency
gps_parse_duration_ms{protocol="teltonika", quantile="0.5"} 0.8
gps_parse_duration_ms{protocol="teltonika", quantile="0.99"} 5.2

# Kafka publish
kafka_publish_duration_ms{topic="gps-events", quantile="0.5"} 1.2
kafka_publish_duration_ms{topic="gps-events", quantile="0.99"} 8.5
```

---

## üìù History Writer

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** Consume –∏–∑ Kafka, –±–∞—Ç—á–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–ø–∏—Å—å –≤ TimescaleDB

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Kafka Consumer Group (–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º)
- Batch insert (1000 –∑–∞–ø–∏—Å–µ–π –∏–ª–∏ 1 —Å–µ–∫—É–Ω–¥–∞)
- Idempotent writes (–ø–æ IMEI + timestamp)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Kafka["Kafka"]
        Topic[gps-events\n12 partitions]
    end

    subgraph Consumers["History Writer Instances"]
        C1[Consumer 1\npartitions 0-3]
        C2[Consumer 2\npartitions 4-7]
        C3[Consumer 3\npartitions 8-11]
    end

    subgraph Processing["Processing (per consumer)"]
        Deser[Deserialize]
        Batch[Batch Aggregator\n1000 records / 1 sec]
        Transform[Transform to SQL]
    end

    subgraph DB["TimescaleDB"]
        Insert[COPY / Batch INSERT]
        Hypertable[gps_points\nhypertable]
    end

    Topic --> C1 & C2 & C3
    C1 & C2 & C3 --> Deser --> Batch --> Transform --> Insert --> Hypertable
```

### Sequence Diagram: –ó–∞–ø–∏—Å—å –±–∞—Ç—á–∞

```mermaid
sequenceDiagram
    participant K as Kafka
    participant HW as History Writer
    participant B as Batch Buffer
    participant DB as TimescaleDB

    loop Consume loop
        K->>HW: Poll messages (max 500)
        HW->>HW: Deserialize GpsPoint
        HW->>B: Add to buffer
        
        alt Buffer >= 1000 OR timeout 1s
            B->>HW: Flush buffer
            HW->>DB: BEGIN
            HW->>DB: COPY gps_points FROM STDIN
            DB-->>HW: Rows inserted
            HW->>DB: COMMIT
            HW->>K: Commit offsets
        end
    end
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. Batch Aggregator

```scala
trait BatchAggregator[A]:
  def add(item: A): Task[Option[Chunk[A]]]  // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç batch –µ—Å–ª–∏ –≥–æ—Ç–æ–≤
  def flush: Task[Chunk[A]]                  // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π flush
  
case class BatchConfig(
  maxSize: Int = 1000,
  maxWait: Duration = 1.second
)
```

#### 2. DB Writer

```scala
trait GpsPointWriter:
  def writeBatch(points: Chunk[GpsPoint]): Task[Int]  // returns rows written

// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç COPY –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
// INSERT ... ON CONFLICT DO NOTHING –¥–ª—è idempotency
```

### TimescaleDB —Å—Ö–µ–º–∞

```sql
-- Hypertable –¥–ª—è GPS —Ç–æ—á–µ–∫
CREATE TABLE gps_points (
    id BIGSERIAL,
    device_id INTEGER NOT NULL,
    imei VARCHAR(20) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    lat DOUBLE PRECISION NOT NULL,
    lon DOUBLE PRECISION NOT NULL,
    altitude SMALLINT,
    speed SMALLINT,            -- –∫–º/—á * 10 (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞)
    course SMALLINT,           -- –≥—Ä–∞–¥—É—Å—ã
    satellites SMALLINT,
    hdop SMALLINT,             -- * 10
    valid BOOLEAN DEFAULT true,
    io_data JSONB,             -- –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    PRIMARY KEY (timestamp, device_id)
);

-- –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ hypertable (–ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
SELECT create_hypertable('gps_points', 'timestamp',
    chunk_time_interval => INTERVAL '1 day'
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_gps_points_device_time 
    ON gps_points (device_id, timestamp DESC);
    
CREATE INDEX idx_gps_points_imei 
    ON gps_points (imei, timestamp DESC);

-- –°–∂–∞—Ç–∏–µ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
ALTER TABLE gps_points SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'device_id',
    timescaledb.compress_orderby = 'timestamp DESC'
);

-- –ü–æ–ª–∏—Ç–∏–∫–∞ —Å–∂–∞—Ç–∏—è (–¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
SELECT add_compression_policy('gps_points', INTERVAL '7 days');

-- –ü–æ–ª–∏—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π)
SELECT add_retention_policy('gps_points', INTERVAL '90 days');
```

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

```
# Batch —Ä–∞–∑–º–µ—Ä—ã
history_writer_batch_size{quantile="0.5"} 850
history_writer_batch_size{quantile="0.99"} 1000

# Latency –∑–∞–ø–∏—Å–∏
history_writer_write_duration_ms{quantile="0.5"} 45
history_writer_write_duration_ms{quantile="0.99"} 150

# Throughput
history_writer_points_written_total 50000000
history_writer_batches_written_total 52000

# Consumer lag
kafka_consumer_lag{topic="gps-events", partition="0"} 150
```

---

## üì± Device Manager

### –û–±–∑–æ—Ä

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** CRUD —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

**–§—É–Ω–∫—Ü–∏–∏:**
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (CRUD)
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –Ω–∞ —Ç—Ä–µ–∫–µ—Ä—ã
- –û—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥ –¥–ª—è offline —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ Redis

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TB
    subgraph Clients["–ö–ª–∏–µ–Ω—Ç—ã"]
        API[API Gateway]
        Admin[Admin Panel]
    end

    subgraph DM["Device Manager"]
        REST[REST Controller]
        DeviceService[Device Service]
        CommandService[Command Service]
    end

    subgraph Storage["–•—Ä–∞–Ω–∏–ª–∏—â–∞"]
        PG[(PostgreSQL\ndevices table)]
        Redis[(Redis\ncommand queue)]
    end

    subgraph CM["Connection Manager"]
        TCPHandler[TCP Handler]
    end

    API & Admin --> REST
    REST --> DeviceService & CommandService
    DeviceService --> PG
    DeviceService --> Redis
    CommandService --> Redis
    Redis -.-> |Pub/Sub| TCPHandler
    TCPHandler -.-> |response| Redis
```

### Sequence Diagram: –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã

```mermaid
sequenceDiagram
    participant UI as Web UI
    participant API as API Gateway
    participant DM as Device Manager
    participant R as Redis
    participant CM as Connection Manager
    participant T as –¢—Ä–µ–∫–µ—Ä

    UI->>API: POST /devices/123/commands {type: "reboot"}
    API->>DM: Send command request
    DM->>R: GET conn:{imei}
    
    alt –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω
        R-->>DM: {nodeId: "cm-1", ...}
        DM->>R: PUBLISH cmd:{imei} {command}
        R-->>CM: Command notification
        CM->>T: Send command packet
        T-->>CM: ACK/Response
        CM->>R: PUBLISH cmd-response:{imei} {result}
        R-->>DM: Response notification
        DM-->>API: {status: "executed", response: ...}
    else –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ñ—Ñ–ª–∞–π–Ω
        R-->>DM: null
        DM->>R: ZADD pending-cmd:{imei} {timestamp} {command}
        DM-->>API: {status: "queued", queuePosition: 3}
    end

    API-->>UI: Command result
```

### Sequence Diagram: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

```mermaid
sequenceDiagram
    participant T as –¢—Ä–µ–∫–µ—Ä
    participant CM as Connection Manager
    participant R as Redis

    T->>CM: Login (IMEI)
    CM->>R: ZRANGE pending-cmd:{imei} 0 -1
    R-->>CM: [{cmd1}, {cmd2}, ...]
    
    loop –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤ –æ—á–µ—Ä–µ–¥–∏
        CM->>T: Send command
        T-->>CM: ACK/Response
        CM->>R: ZREM pending-cmd:{imei} {cmd}
        CM->>R: PUBLISH cmd-response:{imei} {result}
    end
    
    CM->>R: SET conn:{imei} = {...}
```

### PostgreSQL —Å—Ö–µ–º–∞

```sql
-- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
CREATE TABLE devices (
    id SERIAL PRIMARY KEY,
    imei VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100),
    organization_id INTEGER REFERENCES organizations(id),
    device_type_id INTEGER REFERENCES device_types(id),
    protocol VARCHAR(20) NOT NULL,
    phone VARCHAR(20),
    vin VARCHAR(20),
    plate_number VARCHAR(20),
    icon VARCHAR(50) DEFAULT 'car',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ           -- soft delete
);

-- –¢–∏–ø—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–º–æ–¥–µ–ª–∏ —Ç—Ä–µ–∫–µ—Ä–æ–≤)
CREATE TABLE device_types (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,       -- "Teltonika FMB920"
    protocol VARCHAR(20) NOT NULL,   -- "teltonika"
    commands JSONB,                  -- supported commands
    io_elements JSONB                -- IO element mapping
);

-- –ñ—É—Ä–Ω–∞–ª –∫–æ–º–∞–Ω–¥
CREATE TABLE command_log (
    id BIGSERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(id),
    command_type VARCHAR(50) NOT NULL,
    payload JSONB,
    status VARCHAR(20) NOT NULL,     -- pending, sent, executed, failed, timeout
    response JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    sent_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    created_by INTEGER REFERENCES users(id)
);

CREATE INDEX idx_command_log_device ON command_log (device_id, created_at DESC);
CREATE INDEX idx_command_log_status ON command_log (status) WHERE status IN ('pending', 'sent');
```

### Redis —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```
# –û—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥ –¥–ª—è offline —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (ZSET –ø–æ timestamp)
pending-cmd:{imei}
  score: timestamp
  member: {"id": 123, "type": "reboot", "payload": {...}}

# Pub/Sub –∫–∞–Ω–∞–ª—ã
cmd:{imei}           # –∫–æ–º–∞–Ω–¥—ã –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
cmd-response:{imei}  # –æ—Ç–≤–µ—Ç—ã –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

# –ö–µ—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
device:{imei}
  id: 123
  protocol: "teltonika"
  orgId: 456
  config: {...}
  TTL: 3600
```

### REST API

```yaml
# Device CRUD
GET    /api/v1/devices              # —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
GET    /api/v1/devices/{id}         # –æ–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
POST   /api/v1/devices              # —Å–æ–∑–¥–∞—Ç—å
PUT    /api/v1/devices/{id}         # –æ–±–Ω–æ–≤–∏—Ç—å
DELETE /api/v1/devices/{id}         # —É–¥–∞–ª–∏—Ç—å (soft)

# Device position
GET    /api/v1/devices/{id}/position      # –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–∑–∏—Ü–∏—è
GET    /api/v1/devices/{id}/track         # —Ç—Ä–µ–∫ –∑–∞ –ø–µ—Ä–∏–æ–¥

# Commands
POST   /api/v1/devices/{id}/commands      # –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
GET    /api/v1/devices/{id}/commands      # –∏—Å—Ç–æ—Ä–∏—è –∫–æ–º–∞–Ω–¥
GET    /api/v1/commands/{id}              # —Å—Ç–∞—Ç—É—Å –∫–æ–º–∞–Ω–¥—ã

# Bulk operations
POST   /api/v1/devices/import             # –º–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç
POST   /api/v1/devices/export             # —ç–∫—Å–ø–æ—Ä—Ç –≤ CSV
```

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

```
# Device operations
device_manager_operations_total{operation="create"} 150
device_manager_operations_total{operation="update"} 2400
device_manager_operations_total{operation="delete"} 45

# Commands
device_manager_commands_sent_total{type="reboot", status="success"} 1200
device_manager_commands_sent_total{type="reboot", status="queued"} 350
device_manager_commands_sent_total{type="reboot", status="timeout"} 23

# Pending queue
device_manager_pending_commands_total 156

# Cache
device_manager_cache_hits_total 450000
device_manager_cache_misses_total 1200
```

---

## üîó –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ Block 1

```mermaid
sequenceDiagram
    participant T as –¢—Ä–µ–∫–µ—Ä
    participant CM as Connection Manager
    participant DM as Device Manager
    participant HW as History Writer
    participant R as Redis
    participant K as Kafka
    participant DB as TimescaleDB

    Note over T,DB: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    
    T->>CM: TCP Connect + Login (IMEI)
    CM->>R: GET device:{imei}
    R-->>CM: Device config
    CM->>R: SET conn:{imei} = {...}
    CM-->>T: Login ACK

    loop GPS –¥–∞–Ω–Ω—ã–µ
        T->>CM: GPS packet
        CM->>CM: Parse & Filter
        CM->>R: SET pos:{imei} = {...}
        CM->>K: Publish gps-events
    end

    Note over K,DB: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å
    
    K->>HW: Poll messages
    HW->>HW: Batch aggregation
    HW->>DB: COPY gps_points

    Note over DM,T: –ö–æ–º–∞–Ω–¥—ã
    
    DM->>R: PUBLISH cmd:{imei}
    R-->>CM: Command notification
    CM->>T: Send command
    T-->>CM: Response
    CM->>R: PUBLISH cmd-response:{imei}
```

---

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ Block 1

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Connection Manager | History Writer | Device Manager |
|----------|-------------------|----------------|----------------|
| **–¢–∏–ø** | TCP Server | Kafka Consumer | REST API |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ | Kafka partitions | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ |
| **State** | Redis | Stateless | PostgreSQL |
| **–ü–æ—Ä—Ç—ã** | 5001-5004 | - | 8082 (internal) |
| **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è |
| **Latency target** | < 50ms | < 200ms | < 100ms |

---

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Docker Compose (dev)

```yaml
services:
  connection-manager:
    build: ./services/connection-manager
    ports:
      - "5001:5001"
      - "5002:5002"
      - "5003:5003"
      - "5004:5004"
    environment:
      - KAFKA_BROKERS=kafka:9092
      - REDIS_URL=redis://redis:6379
    depends_on:
      - kafka
      - redis

  history-writer:
    build: ./services/history-writer
    environment:
      - KAFKA_BROKERS=kafka:9092
      - DATABASE_URL=postgresql://postgres:5432/tracker
    depends_on:
      - kafka
      - timescaledb

  device-manager:
    build: ./services/device-manager
    ports:
      - "8082:8082"
    environment:
      - DATABASE_URL=postgresql://postgres:5432/tracker
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
```

---

**–î–∞—Ç–∞:** 26 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** Block 1 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ ‚úÖ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** [ARCHITECTURE_BLOCK2.md](./ARCHITECTURE_BLOCK2.md) ‚Äî –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
